<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Unmute</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400&family=IBM+Plex+Sans:wght@300;400&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg:      #080909;
    --surface: #0f1011;
    --border:  #1a1d21;
    --accent:  #00e5a0;
    --accent2: #003d2a;
    --text:    #bfc4cf;
    --dim:     #454d5c;
    --danger:  #ff4d6a;
    --warn:    #ffaa33;
    --mono:    'IBM Plex Mono', monospace;
    --sans:    'IBM Plex Sans', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-weight: 300;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 16px;
  }

  .container {
    width: 100%;
    max-width: 520px;
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  /* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: var(--surface);
    border: 1px solid var(--border);
  }

  .logo {
    font-family: var(--mono);
    font-size: .8rem;
    letter-spacing: .2em;
    color: var(--accent);
  }

  .conn-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .conn-row input {
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--dim);
    font-family: var(--mono);
    font-size: .72rem;
    padding: 2px 4px;
    outline: none;
    width: 180px;
    transition: border-color .2s, color .2s;
  }
  .conn-row input:focus { border-color: var(--accent); color: var(--text); }

  .btn-conn {
    font-family: var(--mono);
    font-size: .68rem;
    letter-spacing: .1em;
    padding: 5px 12px;
    background: transparent;
    border: 1px solid var(--dim);
    color: var(--dim);
    cursor: pointer;
    transition: all .2s;
  }
  .btn-conn:hover        { border-color: var(--accent); color: var(--accent); }
  .btn-conn.active       { border-color: var(--danger); color: var(--danger); }
  .btn-conn.active:hover { background: rgba(255,77,106,.08); }

  .pill {
    font-family: var(--mono);
    font-size: .6rem;
    letter-spacing: .12em;
    padding: 3px 8px;
    border: 1px solid var(--border);
    color: var(--dim);
  }
  .pill.on  { color: var(--accent); border-color: var(--accent2); }
  .pill.err { color: var(--danger); border-color: rgba(255,77,106,.3); }
  .pill.spin::after { content: 'â€¦'; animation: dots 1s steps(3,end) infinite; }
  @keyframes dots { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }

  /* â”€â”€ Conversation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .transcript {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    min-height: 280px;
    max-height: 340px;
    overflow-y: auto;
    padding: 20px 18px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .empty {
    color: var(--dim);
    font-family: var(--mono);
    font-size: .72rem;
    text-align: center;
    margin: auto;
    letter-spacing: .05em;
  }

  .turn {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  .turn-label {
    font-family: var(--mono);
    font-size: .6rem;
    letter-spacing: .15em;
  }
  .turn.user   .turn-label { color: var(--warn); }
  .turn.agent  .turn-label { color: var(--accent); }
  .turn-text {
    font-size: .85rem;
    line-height: 1.65;
    color: var(--text);
  }
  .turn.agent .turn-text { color: #e0e4ed; }

  /* streaming cursor */
  .cursor::after {
    content: 'â–';
    animation: blink .7s step-end infinite;
    color: var(--accent);
    font-size: .7em;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .controls {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    padding: 18px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  /* Mic button */
  .mic-btn {
    width: 64px; height: 64px;
    border-radius: 50%;
    border: 1.5px solid var(--dim);
    background: transparent;
    color: var(--dim);
    font-size: 22px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all .2s;
    position: relative;
  }
  .mic-btn:hover:not(.off) { border-color: var(--text); color: var(--text); }
  .mic-btn.off   { opacity: .28; cursor: not-allowed; }
  .mic-btn.live  {
    border-color: var(--danger);
    color: var(--danger);
    animation: ripple 1.3s ease-out infinite;
  }
  @keyframes ripple {
    0%  { box-shadow: 0 0 0 0   rgba(255,77,106,.45); }
    70% { box-shadow: 0 0 0 14px rgba(255,77,106,0); }
    100%{ box-shadow: 0 0 0 0   rgba(255,77,106,0); }
  }

  /* Right side of controls */
  .ctrl-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .mic-status {
    font-family: var(--mono);
    font-size: .68rem;
    letter-spacing: .08em;
    color: var(--dim);
  }
  .mic-status.live  { color: var(--danger); }
  .mic-status.speak { color: var(--accent); }

  /* Waveform */
  canvas#wave {
    width: 100%;
    height: 36px;
    display: block;
    border-bottom: 1px solid var(--border);
  }

  /* Speaking bars */
  .bars {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 20px;
  }
  .bar {
    width: 3px;
    background: var(--dim);
    border-radius: 1px;
    height: 3px;
    transition: background .2s;
  }
  .bars.speaking .bar { background: var(--accent); }
  .bars.speaking .bar:nth-child(1) { animation: b .7s ease-in-out .00s infinite; }
  .bars.speaking .bar:nth-child(2) { animation: b .7s ease-in-out .12s infinite; }
  .bars.speaking .bar:nth-child(3) { animation: b .7s ease-in-out .24s infinite; }
  .bars.speaking .bar:nth-child(4) { animation: b .7s ease-in-out .36s infinite; }
  .bars.speaking .bar:nth-child(5) { animation: b .7s ease-in-out .48s infinite; }
  .bars.speaking .bar:nth-child(6) { animation: b .7s ease-in-out .60s infinite; }
  @keyframes b { 0%,100%{height:3px} 50%{height:18px} }

  .output-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .output-label {
    font-family: var(--mono);
    font-size: .62rem;
    letter-spacing: .1em;
    color: var(--dim);
    flex-shrink: 0;
  }
  .output-label.speaking { color: var(--accent); }
</style>
</head>
<body>

<div class="container">

  <!-- Top bar: logo + connection -->
  <div class="topbar">
    <div class="logo">UNMUTE</div>
    <div class="conn-row">
      <input id="wsUrl" type="text" value="ws://localhost:3004/ws" spellcheck="false" />
      <button class="btn-conn" id="connectBtn" onclick="toggleConnection()">CONNECT</button>
      <div class="pill" id="statusPill">OFF</div>
    </div>
  </div>

  <!-- Conversation transcript -->
  <div class="transcript" id="transcriptBox">
    <div class="empty" id="emptyMsg">â€” say something â€”</div>
  </div>

  <!-- Controls: mic + output visualizer -->
  <div class="controls">
    <button class="mic-btn off" id="micBtn" onclick="toggleMic()">ğŸ™</button>

    <div class="ctrl-right">
      <canvas id="wave"></canvas>
      <div class="output-row">
        <div class="bars" id="bars">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div>
          <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div class="output-label" id="outputLabel">IDLE</div>
      </div>
      <div class="mic-status" id="micStatus">connect to start</div>
    </div>
  </div>

</div>

<audio id="audioPlayer"></audio>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null, mediaStream = null, audioCtx = null;
let analyser = null, processor = null, recording = false;

const playbackCtx = new (window.AudioContext || window.webkitAudioContext)();
let playbackQueue = [], playbackBusy = false;

// â”€â”€ UI refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const statusPill    = document.getElementById('statusPill');
const connectBtn    = document.getElementById('connectBtn');
const wsUrlInput    = document.getElementById('wsUrl');
const micBtn        = document.getElementById('micBtn');
const micStatus     = document.getElementById('micStatus');
const transcriptBox = document.getElementById('transcriptBox');
const emptyMsg      = document.getElementById('emptyMsg');
const waveCanvas    = document.getElementById('wave');
const wCtx          = waveCanvas.getContext('2d');
const bars          = document.getElementById('bars');
const outputLabel   = document.getElementById('outputLabel');

// â”€â”€ Resize canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas() {
  waveCanvas.width  = waveCanvas.offsetWidth  * devicePixelRatio;
  waveCanvas.height = waveCanvas.offsetHeight * devicePixelRatio;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleConnection() {
  if (ws && ws.readyState === WebSocket.OPEN) { ws.close(); return; }
  connectWS(wsUrlInput.value.trim());
}

function connectWS(url) {
  setStatus('connecting');
  try { ws = new WebSocket(url); } catch(e) { setStatus('error'); return; }
  ws.binaryType = 'arraybuffer';

  ws.onopen = () => { setStatus('connected'); enableMic(); };

  ws.onmessage = (ev) => {
    if (ev.data instanceof ArrayBuffer) {
      handleAudioData(ev.data);
    } else {
      try {
        const msg = JSON.parse(ev.data);
        handleMessage(msg);
      } catch {
        addTurn('agent', ev.data);
      }
    }
  };

  ws.onclose  = () => { setStatus('disconnected'); disableMic(); };
  ws.onerror  = ()  => { setStatus('error'); };
}

function handleMessage(msg) {
  if (msg.type === 'transcript' || msg.text) {
    const role = msg.role === 'user' || msg.source === 'stt' ? 'user' : 'agent';
    addTurn(role, msg.text || msg.transcript);
  }
  if (msg.type === 'audio' && msg.data) {
    const bytes = Uint8Array.from(atob(msg.data), c => c.charCodeAt(0));
    handleAudioData(bytes.buffer);
  }
}

// â”€â”€ Transcript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addTurn(role, text) {
  if (emptyMsg) emptyMsg.remove();
  const t = document.createElement('div');
  t.className = `turn ${role}`;
  t.innerHTML = `<span class="turn-label">${role === 'user' ? 'YOU' : 'AGENT'}</span><span class="turn-text">${escHtml(text)}</span>`;
  transcriptBox.appendChild(t);
  transcriptBox.scrollTop = transcriptBox.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Mic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enableMic() {
  micBtn.classList.remove('off');
  setMicStatus('idle');
}

function disableMic() {
  if (recording) stopRecording();
  micBtn.classList.add('off');
  setMicStatus('connect to start');
}

async function toggleMic() {
  if (micBtn.classList.contains('off')) return;
  recording ? stopRecording() : await startRecording();
}

async function startRecording() {
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: { sampleRate: 16000, channelCount: 1, echoCancellation: true, noiseSuppression: true }
    });
  } catch(e) { setMicStatus('mic denied'); return; }

  audioCtx = new AudioContext({ sampleRate: 16000 });
  const source = audioCtx.createMediaStreamSource(mediaStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);

  processor = audioCtx.createScriptProcessor(4096, 1, 1);
  source.connect(processor);
  processor.connect(audioCtx.destination);

  processor.onaudioprocess = (e) => {
    if (!recording || !ws || ws.readyState !== WebSocket.OPEN) return;
    ws.send(e.inputBuffer.getChannelData(0).buffer.slice(0));
  };

  recording = true;
  micBtn.classList.add('live');
  setMicStatus('recording', 'live');
  drawWave();
}

function stopRecording() {
  recording = false;
  processor?.disconnect();
  analyser?.disconnect();
  mediaStream?.getTracks().forEach(t => t.stop());
  audioCtx?.close();
  processor = analyser = mediaStream = audioCtx = null;

  if (ws?.readyState === WebSocket.OPEN)
    ws.send(JSON.stringify({ type: 'flush' }));

  micBtn.classList.remove('live');
  setMicStatus('idle');
  clearWave();
}

// â”€â”€ Waveform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearWave() {
  wCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
}

function drawWave() {
  if (!analyser) return;
  requestAnimationFrame(drawWave);
  const buf = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteTimeDomainData(buf);
  const W = waveCanvas.width / devicePixelRatio;
  const H = waveCanvas.height / devicePixelRatio;
  wCtx.save();
  wCtx.scale(devicePixelRatio, devicePixelRatio);
  wCtx.clearRect(0, 0, W, H);
  wCtx.strokeStyle = '#ff4d6a';
  wCtx.lineWidth = 1.2;
  wCtx.beginPath();
  buf.forEach((v, i) => {
    const x = (i / buf.length) * W;
    const y = (v / 128) * (H / 2);
    i === 0 ? wCtx.moveTo(x, y) : wCtx.lineTo(x, y);
  });
  wCtx.stroke();
  wCtx.restore();
}

// â”€â”€ Audio playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleAudioData(buffer) {
  playbackQueue.push(buffer);
  if (!playbackBusy) drainQueue();
}

async function drainQueue() {
  if (!playbackQueue.length) { setSpeaking(false); return; }
  playbackBusy = true;
  setSpeaking(true);
  const buf = playbackQueue.shift();
  try {
    const decoded = await playbackCtx.decodeAudioData(buf.slice(0));
    const src = playbackCtx.createBufferSource();
    src.buffer = decoded;
    src.connect(playbackCtx.destination);
    src.onended = () => { playbackBusy = false; drainQueue(); };
    src.start();
  } catch {
    playRawPCM(buf);
  }
}

function playRawPCM(buffer) {
  const f32  = new Float32Array(buffer);
  const abuf = playbackCtx.createBuffer(1, f32.length, 24000);
  abuf.getChannelData(0).set(f32);
  const src = playbackCtx.createBufferSource();
  src.buffer = abuf;
  src.connect(playbackCtx.destination);
  src.onended = () => { playbackBusy = false; drainQueue(); };
  src.start();
}

function setSpeaking(on) {
  if (on) {
    bars.classList.add('speaking');
    outputLabel.textContent = 'SPEAKING';
    outputLabel.classList.add('speaking');
  } else {
    bars.classList.remove('speaking');
    outputLabel.textContent = 'IDLE';
    outputLabel.classList.remove('speaking');
  }
}

// â”€â”€ Status helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(s) {
  statusPill.className = 'pill';
  connectBtn.className = 'btn-conn';
  wsUrlInput.disabled  = s !== 'disconnected' && s !== 'error';

  const map = {
    connected:    ['on',  'ON',          'DISCONNECT', 'active'],
    connecting:   ['spin','CONNECTING',  'CANCEL',     ''],
    disconnected: ['',    'OFF',         'CONNECT',    ''],
    error:        ['err', 'ERROR',       'RETRY',      ''],
  };
  const [cls, label, btn, btnCls] = map[s] || map.disconnected;
  if (cls) statusPill.classList.add(cls);
  statusPill.textContent = label;
  connectBtn.textContent = btn;
  if (btnCls) connectBtn.classList.add(btnCls);
}

function setMicStatus(msg, cls = '') {
  micStatus.className = 'mic-status' + (cls ? ' ' + cls : '');
  micStatus.textContent = msg;
}
</script>
</body>
</html>