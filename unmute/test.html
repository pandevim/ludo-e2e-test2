<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Unmute â€” Voice Pipeline</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg:       #0a0b0d;
    --surface:  #111316;
    --border:   #1f2228;
    --accent:   #00e5a0;
    --accent2:  #005c41;
    --muted:    #3a3f4a;
    --text:     #c8cdd8;
    --dim:      #5a6070;
    --danger:   #ff4d6a;
    --warn:     #ffaa33;
    --mono:     'Share Tech Mono', monospace;
    --sans:     'DM Sans', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 16px 40px;
    overflow-x: hidden;
  }

  /* scanline overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,.08) 2px,
      rgba(0,0,0,.08) 4px
    );
    pointer-events: none;
    z-index: 100;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    width: 100%; max-width: 760px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 24px 0 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: var(--mono);
    font-size: 1.1rem;
    letter-spacing: .12em;
    color: var(--accent);
  }
  .logo span { color: var(--dim); }

  .status-pill {
    font-family: var(--mono);
    font-size: .72rem;
    letter-spacing: .1em;
    padding: 4px 12px;
    border-radius: 2px;
    border: 1px solid var(--border);
    color: var(--dim);
    transition: all .3s;
  }
  .status-pill.connected  { color: var(--accent); border-color: var(--accent2); background: rgba(0,229,160,.05); }
  .status-pill.connecting { color: var(--warn);   border-color: rgba(255,170,51,.3); }
  .status-pill.error      { color: var(--danger); border-color: rgba(255,77,106,.3); }

  /* â”€â”€ Connection Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .conn-bar {
    width: 100%; max-width: 760px;
    display: flex; gap: 8px;
    margin-top: 20px;
  }

  .conn-bar input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: .85rem;
    padding: 10px 14px;
    border-radius: 3px;
    outline: none;
    transition: border-color .2s;
  }
  .conn-bar input:focus { border-color: var(--accent); }
  .conn-bar input::placeholder { color: var(--muted); }

  button {
    font-family: var(--sans);
    font-size: .85rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    border-radius: 3px;
    transition: all .2s;
  }

  .btn-connect {
    background: var(--accent2);
    color: var(--accent);
    border: 1px solid var(--accent);
    padding: 10px 20px;
    letter-spacing: .05em;
  }
  .btn-connect:hover { background: rgba(0,229,160,.15); }
  .btn-connect.disconnect { background: rgba(255,77,106,.1); color: var(--danger); border-color: var(--danger); }
  .btn-connect.disconnect:hover { background: rgba(255,77,106,.2); }

  /* â”€â”€ Main Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    width: 100%; max-width: 760px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
  }

  /* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }
  .panel.full { grid-column: span 2; }

  .panel-label {
    font-family: var(--mono);
    font-size: .65rem;
    letter-spacing: .15em;
    color: var(--dim);
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px;
  }
  .panel-label .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
  }
  .panel-label .dot.live { background: var(--accent); box-shadow: 0 0 6px var(--accent); animation: pulse 1.4s ease-in-out infinite; }
  .panel-label .dot.err  { background: var(--danger); }

  @keyframes pulse {
    0%,100% { opacity: 1; } 50% { opacity: .3; }
  }

  /* â”€â”€ Mic section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mic-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 24px 16px;
  }

  .mic-btn {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: transparent;
    border: 2px solid var(--muted);
    color: var(--muted);
    font-size: 28px;
    display: flex; align-items: center; justify-content: center;
    transition: all .25s;
    position: relative;
  }
  .mic-btn:hover { border-color: var(--text); color: var(--text); }
  .mic-btn.recording {
    border-color: var(--danger);
    color: var(--danger);
    box-shadow: 0 0 0 0 rgba(255,77,106,.4);
    animation: ripple 1.2s ease-out infinite;
  }
  .mic-btn.disabled { opacity: .3; cursor: not-allowed; }

  @keyframes ripple {
    0%  { box-shadow: 0 0 0 0 rgba(255,77,106,.4); }
    70% { box-shadow: 0 0 0 16px rgba(255,77,106,0); }
    100%{ box-shadow: 0 0 0 0 rgba(255,77,106,0); }
  }

  .mic-hint {
    font-size: .78rem;
    color: var(--dim);
    text-align: center;
    letter-spacing: .02em;
  }

  /* â”€â”€ Waveform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  canvas#waveform {
    width: 100%; height: 56px;
    display: block;
  }

  /* â”€â”€ Transcript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .transcript-box {
    height: 220px;
    overflow-y: auto;
    padding: 12px 14px;
    font-size: .82rem;
    line-height: 1.7;
    scrollbar-width: thin;
    scrollbar-color: var(--muted) transparent;
  }

  .turn { margin-bottom: 10px; display: flex; gap: 10px; }
  .turn-label {
    font-family: var(--mono);
    font-size: .65rem;
    letter-spacing: .08em;
    flex-shrink: 0;
    padding-top: 2px;
  }
  .turn.user   .turn-label { color: var(--warn); }
  .turn.assistant .turn-label { color: var(--accent); }
  .turn-text { color: var(--text); }

  /* â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .log-box {
    height: 140px;
    overflow-y: auto;
    padding: 10px 14px;
    font-family: var(--mono);
    font-size: .72rem;
    line-height: 1.8;
    color: var(--dim);
    scrollbar-width: thin;
    scrollbar-color: var(--muted) transparent;
  }
  .log-entry { display: flex; gap: 10px; }
  .log-ts { color: var(--muted); flex-shrink: 0; }
  .log-msg.ok  { color: var(--accent); }
  .log-msg.err { color: var(--danger); }
  .log-msg.info{ color: var(--dim); }

  /* â”€â”€ Audio playback indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .speaking-bar {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 14px;
    font-family: var(--mono);
    font-size: .65rem;
    color: var(--dim);
    border-top: 1px solid var(--border);
    min-height: 34px;
  }
  .speaking-bar.active { color: var(--accent); }
  .bars { display: flex; gap: 2px; align-items: flex-end; height: 16px; }
  .bar {
    width: 3px; background: var(--muted); border-radius: 1px;
    animation: none;
  }
  .speaking-bar.active .bar {
    background: var(--accent);
  }
  .speaking-bar.active .bar:nth-child(1) { animation: bar 0.8s ease-in-out .0s infinite; }
  .speaking-bar.active .bar:nth-child(2) { animation: bar 0.8s ease-in-out .15s infinite; }
  .speaking-bar.active .bar:nth-child(3) { animation: bar 0.8s ease-in-out .3s infinite; }
  .speaking-bar.active .bar:nth-child(4) { animation: bar 0.8s ease-in-out .45s infinite; }
  .speaking-bar.active .bar:nth-child(5) { animation: bar 0.8s ease-in-out .6s infinite; }

  @keyframes bar {
    0%,100% { height: 3px; } 50% { height: 14px; }
  }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer {
    width: 100%; max-width: 760px;
    margin-top: 14px;
    display: flex; gap: 8px; flex-wrap: wrap;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }

  .chip {
    font-family: var(--mono);
    font-size: .65rem;
    letter-spacing: .08em;
    padding: 4px 10px;
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--dim);
  }
  .chip b { color: var(--text); font-weight: 400; }
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">UNMUTE<span>/voice</span></div>
  <div class="status-pill" id="statusPill">DISCONNECTED</div>
</header>

<!-- Connection Bar -->
<div class="conn-bar">
  <input id="wsUrl" type="text" value="ws://localhost:3004/ws" placeholder="ws://host:3004/ws" />
  <button class="btn-connect" id="connectBtn" onclick="toggleConnection()">CONNECT</button>
</div>

<!-- Main -->
<div class="main">

  <!-- Mic + Waveform -->
  <div class="panel">
    <div class="panel-label">
      <div class="dot" id="micDot"></div>
      MICROPHONE INPUT
    </div>
    <div class="mic-section">
      <button class="mic-btn disabled" id="micBtn" onclick="toggleMic()" title="Push to talk / hold to record">
        ðŸŽ™
      </button>
      <div class="mic-hint" id="micHint">Connect first to enable mic</div>
    </div>
    <canvas id="waveform"></canvas>
  </div>

  <!-- Playback -->
  <div class="panel">
    <div class="panel-label">
      <div class="dot" id="ttsDot"></div>
      AUDIO OUTPUT
    </div>
    <div class="mic-section" style="padding-top:28px">
      <div style="font-size:40px">ðŸ”Š</div>
      <div class="mic-hint" id="playbackStatus">Waiting for responseâ€¦</div>
      <div style="width:100%; background: var(--bg); border-radius:2px; height:4px; overflow:hidden; margin-top:4px;">
        <div id="playbackBar" style="height:100%; width:0%; background:var(--accent); transition:width .1s;"></div>
      </div>
    </div>
    <div class="speaking-bar" id="speakingBar">
      <div class="bars">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div>
      </div>
      <span id="speakingLabel">IDLE</span>
    </div>
  </div>

  <!-- Transcript -->
  <div class="panel full">
    <div class="panel-label">
      <div class="dot" id="transcriptDot"></div>
      CONVERSATION
      <span style="margin-left:auto; cursor:pointer; font-size:.7rem;" onclick="clearTranscript()">CLEAR</span>
    </div>
    <div class="transcript-box" id="transcriptBox">
      <div style="color:var(--muted); font-style:italic; font-size:.78rem;">Conversation will appear hereâ€¦</div>
    </div>
  </div>

  <!-- Log -->
  <div class="panel full">
    <div class="panel-label">
      <div class="dot"></div>
      SYSTEM LOG
    </div>
    <div class="log-box" id="logBox"></div>
  </div>

</div>

<!-- Footer chips -->
<footer>
  <div class="chip">STT <b>kyutai/stt-2.6b-en</b></div>
  <div class="chip">LLM <b>deepseek-ai/DeepSeek-V3.2</b></div>
  <div class="chip">TTS <b>kyutai/tts-0.75b-en-public</b></div>
  <div class="chip">ORCH <b>:3004</b></div>
</footer>

<audio id="audioPlayer"></audio>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws            = null;
let mediaStream   = null;
let audioCtx      = null;
let analyser      = null;
let processor     = null;
let recording     = false;
let audioQueue    = [];
let isPlaying     = false;

const SAMPLE_RATE  = 16000;  // expected by STT
const CHUNK_MS     = 60;

// â”€â”€ UI refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const statusPill     = document.getElementById('statusPill');
const connectBtn     = document.getElementById('connectBtn');
const wsUrlInput     = document.getElementById('wsUrl');
const micBtn         = document.getElementById('micBtn');
const micHint        = document.getElementById('micHint');
const micDot         = document.getElementById('micDot');
const ttsDot         = document.getElementById('ttsDot');
const speakingBar    = document.getElementById('speakingBar');
const speakingLabel  = document.getElementById('speakingLabel');
const transcriptBox  = document.getElementById('transcriptBox');
const logBox         = document.getElementById('logBox');
const waveCanvas     = document.getElementById('waveform');
const ctx2d          = waveCanvas.getContext('2d');
const playbackStatus = document.getElementById('playbackStatus');
const playbackBar    = document.getElementById('playbackBar');

// â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type = 'info') {
  const now = new Date().toTimeString().slice(0,8);
  const row = document.createElement('div');
  row.className = 'log-entry';
  row.innerHTML = `<span class="log-ts">${now}</span><span class="log-msg ${type}">${msg}</span>`;
  logBox.appendChild(row);
  logBox.scrollTop = logBox.scrollHeight;
}

// â”€â”€ Transcript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addTurn(role, text) {
  // Remove placeholder
  const placeholder = transcriptBox.querySelector('div[style*="italic"]');
  if (placeholder) placeholder.remove();

  const turn = document.createElement('div');
  turn.className = `turn ${role}`;
  turn.innerHTML = `<span class="turn-label">${role === 'user' ? 'YOU' : 'AI '}</span><span class="turn-text"></span>`;
  turn.querySelector('.turn-text').textContent = text;
  transcriptBox.appendChild(turn);
  transcriptBox.scrollTop = transcriptBox.scrollHeight;

  document.getElementById('transcriptDot').classList.add('live');
  setTimeout(() => document.getElementById('transcriptDot').classList.remove('live'), 1200);
}

function clearTranscript() {
  transcriptBox.innerHTML = '<div style="color:var(--muted); font-style:italic; font-size:.78rem;">Conversation will appear hereâ€¦</div>';
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleConnection() {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.close();
  } else {
    connectWS(wsUrlInput.value.trim());
  }
}

function connectWS(url) {
  setStatus('connecting');
  log(`Connecting to ${url}â€¦`);

  try { ws = new WebSocket(url); }
  catch(e) { log('Invalid WebSocket URL: ' + e.message, 'err'); setStatus('error'); return; }

  ws.binaryType = 'arraybuffer';

  ws.onopen = () => {
    setStatus('connected');
    log('WebSocket connected', 'ok');
    enableMic();
  };

  ws.onmessage = (ev) => {
    if (ev.data instanceof ArrayBuffer) {
      // Binary = TTS audio (PCM float32 or wav bytes)
      handleAudioData(ev.data);
    } else {
      // JSON message
      try {
        const msg = JSON.parse(ev.data);
        handleMessage(msg);
      } catch {
        // Plain text transcript
        log(`â† ${ev.data}`, 'info');
        addTurn('assistant', ev.data);
      }
    }
  };

  ws.onclose = (ev) => {
    setStatus('disconnected');
    log(`Disconnected (code ${ev.code})`, 'err');
    disableMic();
  };

  ws.onerror = () => {
    log('WebSocket error â€” check URL and server', 'err');
    setStatus('error');
  };
}

function handleMessage(msg) {
  // Handle structured messages from orchestrator
  // Typical patterns:
  if (msg.type === 'transcript' || msg.text) {
    const role = msg.role || (msg.source === 'stt' ? 'user' : 'assistant');
    addTurn(role, msg.text || msg.transcript);
    log(`[${role.toUpperCase()}] ${(msg.text||msg.transcript).slice(0,80)}`, 'info');
  }
  if (msg.type === 'audio' && msg.data) {
    // base64-encoded audio
    const bytes = Uint8Array.from(atob(msg.data), c => c.charCodeAt(0));
    handleAudioData(bytes.buffer);
  }
  if (msg.type === 'status') {
    log(`[status] ${msg.message || JSON.stringify(msg)}`, 'info');
  }
  if (msg.type === 'error') {
    log(`[error] ${msg.message || JSON.stringify(msg)}`, 'err');
  }
}

// â”€â”€ Mic / Recording â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enableMic() {
  micBtn.classList.remove('disabled');
  micHint.textContent = 'Click to start recording';
}

function disableMic() {
  if (recording) stopRecording();
  micBtn.classList.add('disabled');
  micHint.textContent = 'Connect first to enable mic';
}

async function toggleMic() {
  if (micBtn.classList.contains('disabled')) return;
  if (recording) { stopRecording(); return; }
  await startRecording();
}

async function startRecording() {
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { sampleRate: SAMPLE_RATE, channelCount: 1, echoCancellation: true, noiseSuppression: true } });
  } catch(e) {
    log('Mic access denied: ' + e.message, 'err');
    return;
  }

  audioCtx = new AudioContext({ sampleRate: SAMPLE_RATE });
  const source = audioCtx.createMediaStreamSource(mediaStream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);

  // ScriptProcessor for raw PCM (widely supported)
  const bufSize = Math.floor(SAMPLE_RATE * CHUNK_MS / 1000);
  processor = audioCtx.createScriptProcessor(4096, 1, 1);

  source.connect(processor);
  processor.connect(audioCtx.destination);

  processor.onaudioprocess = (e) => {
    if (!recording) return;
    const f32 = e.inputBuffer.getChannelData(0);
    if (ws && ws.readyState === WebSocket.OPEN) {
      // Send raw float32 PCM
      ws.send(f32.buffer.slice(0));
    }
  };

  recording = true;
  micBtn.classList.add('recording');
  micDot.classList.add('live');
  micHint.textContent = 'Recordingâ€¦ click to stop';
  log('Microphone recording started', 'ok');
  drawWaveform();
}

function stopRecording() {
  recording = false;
  processor?.disconnect();
  analyser?.disconnect();
  mediaStream?.getTracks().forEach(t => t.stop());
  audioCtx?.close();
  processor = analyser = mediaStream = audioCtx = null;

  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'flush' }));
  }

  micBtn.classList.remove('recording');
  micDot.classList.remove('live');
  micHint.textContent = 'Click to start recording';
  log('Microphone stopped', 'info');
  clearWaveform();
}

// â”€â”€ Waveform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas() {
  waveCanvas.width  = waveCanvas.offsetWidth  * devicePixelRatio;
  waveCanvas.height = waveCanvas.offsetHeight * devicePixelRatio;
  ctx2d.scale(devicePixelRatio, devicePixelRatio);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function clearWaveform() {
  ctx2d.clearRect(0,0,waveCanvas.offsetWidth, waveCanvas.offsetHeight);
}

function drawWaveform() {
  if (!analyser) return;
  requestAnimationFrame(drawWaveform);
  const buf = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteTimeDomainData(buf);

  const W = waveCanvas.offsetWidth;
  const H = waveCanvas.offsetHeight;
  ctx2d.clearRect(0,0,W,H);
  ctx2d.strokeStyle = '#ff4d6a';
  ctx2d.lineWidth   = 1.5;
  ctx2d.beginPath();

  const step = W / buf.length;
  buf.forEach((v, i) => {
    const x = i * step;
    const y = (v / 128) * (H / 2);
    i === 0 ? ctx2d.moveTo(x, y) : ctx2d.lineTo(x, y);
  });
  ctx2d.stroke();
}

// â”€â”€ TTS Audio playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Accumulate binary chunks and play them as WAV/PCM
const playbackCtx = new (window.AudioContext || window.webkitAudioContext)();
let playbackQueue = [];
let playbackBusy  = false;

function handleAudioData(buffer) {
  log(`Audio chunk received (${buffer.byteLength} bytes)`, 'ok');
  playbackQueue.push(buffer);
  if (!playbackBusy) drainAudioQueue();
}

async function drainAudioQueue() {
  if (playbackQueue.length === 0) {
    setSpeaking(false);
    return;
  }
  playbackBusy = true;
  setSpeaking(true);

  const buffer = playbackQueue.shift();

  try {
    const decoded = await playbackCtx.decodeAudioData(buffer.slice(0));
    const source = playbackCtx.createBufferSource();
    source.buffer = decoded;
    source.connect(playbackCtx.destination);
    source.onended = () => {
      playbackBusy = false;
      drainAudioQueue();
    };
    source.start();
    playbackStatus.textContent = `Playing (${(buffer.byteLength/1024).toFixed(1)} KB)`;
    ttsDot.classList.add('live');
  } catch(e) {
    // Maybe raw PCM float32?
    playRawPCM(buffer);
  }
}

function playRawPCM(buffer) {
  // Assume float32 @ 24000 Hz (moshi TTS default)
  const f32 = new Float32Array(buffer);
  const abuf = playbackCtx.createBuffer(1, f32.length, 24000);
  abuf.getChannelData(0).set(f32);
  const src = playbackCtx.createBufferSource();
  src.buffer = abuf;
  src.connect(playbackCtx.destination);
  src.onended = () => {
    playbackBusy = false;
    drainAudioQueue();
  };
  src.start();
  setSpeaking(true);
  playbackStatus.textContent = `Playing PCM (${(buffer.byteLength/1024).toFixed(1)} KB)`;
  ttsDot.classList.add('live');
}

function setSpeaking(active) {
  if (active) {
    speakingBar.classList.add('active');
    speakingLabel.textContent = 'SPEAKING';
  } else {
    speakingBar.classList.remove('active');
    speakingLabel.textContent = 'IDLE';
    playbackStatus.textContent = 'Waiting for responseâ€¦';
    ttsDot.classList.remove('live');
  }
}

// â”€â”€ Status helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state) {
  statusPill.className = 'status-pill';
  connectBtn.className = 'btn-connect';

  if (state === 'connected') {
    statusPill.textContent = 'CONNECTED';
    statusPill.classList.add('connected');
    connectBtn.textContent = 'DISCONNECT';
    connectBtn.classList.add('disconnect');
    wsUrlInput.disabled = true;
  } else if (state === 'connecting') {
    statusPill.textContent = 'CONNECTINGâ€¦';
    statusPill.classList.add('connecting');
    connectBtn.textContent = 'CANCEL';
    wsUrlInput.disabled = true;
  } else if (state === 'error') {
    statusPill.textContent = 'ERROR';
    statusPill.classList.add('error');
    connectBtn.textContent = 'RETRY';
    wsUrlInput.disabled = false;
  } else {
    statusPill.textContent = 'DISCONNECTED';
    connectBtn.textContent = 'CONNECT';
    wsUrlInput.disabled = false;
  }
}

log('Unmute client ready', 'ok');
log('Enter WebSocket URL and click CONNECT', 'info');
</script>
</body>
</html>