<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qwen API Tester</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --border: #1e1e2e;
    --accent: #7fff6e;
    --accent2: #00d4ff;
    --text: #e8e8f0;
    --muted: #555570;
    --user-bg: #1a1a2e;
    --ai-bg: #0f1a0f;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(127,255,110,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(127,255,110,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none; z-index: 0;
  }
  header {
    position: relative; z-index: 10;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 12px;
    background: rgba(10,10,15,0.9);
    backdrop-filter: blur(10px);
  }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent); box-shadow: 0 0 8px var(--accent);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .model-label {
    font-family: 'Syne', sans-serif; font-weight: 800; font-size: 14px;
    color: var(--accent); letter-spacing: 0.05em; text-transform: uppercase;
  }
  .endpoint {
    margin-left: auto; font-size: 11px; color: var(--muted);
    border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px;
  }
  #chat-container {
    flex: 1; overflow-y: auto;
    padding: 24px 274px 24px 24px;
    position: relative; z-index: 1;
    display: flex; flex-direction: column; gap: 16px;
    scroll-behavior: smooth;
  }
  #chat-container::-webkit-scrollbar { width: 4px; }
  #chat-container::-webkit-scrollbar-track { background: transparent; }
  #chat-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .message {
    display: flex; gap: 12px; max-width: 760px;
    animation: fadeSlide 0.3s ease forwards;
    opacity: 0; transform: translateY(8px);
  }
  @keyframes fadeSlide { to { opacity:1; transform:translateY(0); } }
  .message.user { margin-left: auto; flex-direction: row-reverse; }
  .avatar {
    width: 32px; height: 32px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 600; flex-shrink: 0;
  }
  .message.user .avatar { background:var(--user-bg); border:1px solid var(--accent2); color:var(--accent2); }
  .message.assistant .avatar { background:var(--ai-bg); border:1px solid var(--accent); color:var(--accent); }
  .bubble {
    padding: 12px 16px; border-radius: 8px;
    font-size: 13px; line-height: 1.6; max-width: 600px;
    white-space: pre-wrap; word-break: break-word;
  }
  .message.user .bubble { background:var(--user-bg); border:1px solid rgba(0,212,255,0.2); border-top-right-radius:2px; }
  .message.assistant .bubble { background:var(--ai-bg); border:1px solid rgba(127,255,110,0.2); border-top-left-radius:2px; }
  .thinking { display:flex; gap:4px; align-items:center; padding:8px 0; }
  .thinking span { width:6px; height:6px; background:var(--accent); border-radius:50%; animation:bounce 1.2s infinite; }
  .thinking span:nth-child(2) { animation-delay:0.2s; }
  .thinking span:nth-child(3) { animation-delay:0.4s; }
  @keyframes bounce { 0%,60%,100%{transform:translateY(0);opacity:0.4} 30%{transform:translateY(-6px);opacity:1} }
  .input-area {
    position: relative; z-index: 10;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    background: rgba(10,10,15,0.9);
    backdrop-filter: blur(10px);
  }
  .input-row { display:flex; gap:10px; align-items:flex-end; max-width:800px; margin:0 auto; }
  #user-input {
    flex: 1; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 13px; padding: 12px 16px; border-radius: 8px;
    resize: none; outline: none; min-height: 46px; max-height: 120px;
    line-height: 1.5; transition: border-color 0.2s;
  }
  #user-input:focus { border-color: var(--accent); }
  #user-input::placeholder { color: var(--muted); }
  #send-btn {
    background: var(--accent); color: #0a0a0f; border: none;
    padding: 12px 20px; border-radius: 8px;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    cursor: pointer; white-space: nowrap;
    transition: opacity 0.2s, transform 0.1s; letter-spacing: 0.05em;
  }
  #send-btn:hover { opacity:0.85; }
  #send-btn:active { transform:scale(0.97); }
  #send-btn:disabled { opacity:0.3; cursor:not-allowed; }
  .error-bubble {
    background: rgba(255,80,80,0.1); border: 1px solid rgba(255,80,80,0.3);
    color: #ff8080; padding: 10px 14px; border-radius: 8px; font-size: 12px;
    margin: 0 auto; max-width: 600px;
    animation: fadeSlide 0.3s ease forwards; opacity: 0;
  }
  .empty-state {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 12px; color: var(--muted); text-align: center;
  }
  .empty-state .icon { font-size:40px; filter:grayscale(1); opacity:0.4; }
  .empty-state p { font-size:12px; }
  .empty-state code {
    background:var(--surface); padding:2px 8px;
    border-radius:4px; color:var(--accent); font-size:11px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     METRICS PANEL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #metrics-panel {
    position: fixed;
    top: 64px; right: 12px;
    width: 250px;
    background: rgba(8, 8, 14, 0.97);
    border: 1px solid var(--border);
    border-radius: 10px;
    backdrop-filter: blur(20px);
    z-index: 200;
    overflow: hidden;
    box-shadow: 0 10px 48px rgba(0,0,0,0.55),
                inset 0 1px 0 rgba(255,255,255,0.04);
  }

  #m-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 9px 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none;
    background: rgba(0,212,255,0.04);
    transition: background 0.2s;
  }
  #m-header:hover { background: rgba(0,212,255,0.08); }

  .m-title {
    font-family: 'Syne', sans-serif; font-weight: 700;
    font-size: 10px; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--accent2);
    display: flex; align-items: center; gap: 7px;
  }
  .live-dot {
    width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
    background: var(--accent); box-shadow: 0 0 6px var(--accent);
    animation: pulse 2s infinite;
    transition: background 0.3s, box-shadow 0.3s;
  }
  .live-dot.stale { background:#ffcc44; box-shadow:0 0 6px #ffcc44; animation:none; }
  .live-dot.dead  { background:#ff4444; box-shadow:0 0 6px #ff4444; animation:none; }

  #m-toggle {
    background: none; border: none; color: var(--muted);
    font-size: 11px; cursor: pointer; padding: 2px 4px; line-height: 1;
    transition: transform 0.3s, color 0.2s;
  }
  #m-toggle:hover { color: var(--text); }
  #metrics-panel.collapsed #m-toggle { transform: rotate(180deg); }

  #m-body {
    max-height: 700px;
    overflow: hidden;
    opacity: 1;
    transition: max-height 0.35s ease, opacity 0.25s ease;
  }
  #metrics-panel.collapsed #m-body { max-height: 0; opacity: 0; }

  #m-inner {
    padding: 10px 12px 12px;
    display: flex; flex-direction: column; gap: 10px;
  }

  .m-section { display:flex; flex-direction:column; gap:5px; }
  .m-sec-title {
    font-size: 8.5px; letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); padding-bottom: 4px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 1px;
  }
  .m-row {
    display: flex; justify-content: space-between;
    align-items: baseline; gap: 6px;
  }
  .m-lbl { font-size:10px; color:#6e6e90; white-space:nowrap; flex-shrink:0; }
  .m-val {
    font-size: 11px; font-weight: 600; color: var(--text);
    white-space: nowrap; font-variant-numeric: tabular-nums;
    transition: color 0.4s;
  }
  .m-val.g { color: var(--accent); }
  .m-val.c { color: var(--accent2); }
  .m-val.y { color: #ffcc44; }
  .m-val.r { color: #ff5555; }

  .m-badge {
    font-size: 9px; font-weight: 700; letter-spacing: 0.06em;
    text-transform: uppercase; padding: 2px 8px; border-radius: 3px;
  }
  .m-badge.awake { background:rgba(127,255,110,0.1); color:var(--accent); border:1px solid rgba(127,255,110,0.25); }
  .m-badge.sleep { background:rgba(255,85,85,0.1);   color:#ff5555;       border:1px solid rgba(255,85,85,0.25); }

  .m-bar-wrap { display:flex; flex-direction:column; gap:4px; }
  .m-bar-top  { display:flex; justify-content:space-between; align-items:baseline; }
  .m-track {
    width:100%; height:3px;
    background:rgba(255,255,255,0.06);
    border-radius:2px; overflow:hidden;
  }
  .m-fill {
    height:100%; border-radius:2px;
    transition: width 0.7s ease, background-color 0.4s;
  }
  .m-fill.g { background:var(--accent); }
  .m-fill.y { background:#ffcc44; }
  .m-fill.r { background:#ff5555; }

  #m-footer {
    font-size:9px; color:var(--muted); text-align:right;
    padding-top:6px; border-top:1px solid rgba(255,255,255,0.04);
  }

  /* offline state */
  #m-offline {
    display:none; padding:14px 12px;
    font-size:10px; color:#ff7070;
    line-height:1.7; text-align:center;
  }
  #m-offline .off-icon { font-size:22px; display:block; margin-bottom:6px; }
</style>
</head>
<body>

<header>
  <div class="status-dot"></div>
  <span class="model-label">Qwen2.5-Coder-0.5B</span>
  <span class="endpoint" id="endpoint-display">localhost:8080/v1/chat/completions</span>
</header>

<div id="chat-container">
  <div class="empty-state" id="empty-state">
    <div class="icon">âš¡</div>
    <p>Connected to <code>Qwen/Qwen2.5-Coder-0.5B-Instruct-AWQ</code></p>
    <p>Send a message to begin</p>
  </div>
</div>

<div class="input-area">
  <div class="input-row">
    <textarea id="user-input" placeholder="Type a messageâ€¦ (Enter to send, Shift+Enter for newline)" rows="1"></textarea>
    <button id="send-btn">SEND</button>
  </div>
</div>

<!-- â•â• Metrics Panel â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="metrics-panel">

  <div id="m-header">
    <div class="m-title">
      <span class="live-dot" id="m-dot"></span>
      vLLM Metrics
    </div>
    <button id="m-toggle" title="Toggle">â–¼</button>
  </div>

  <div id="m-body">
    <div id="m-inner">

      <!-- offline notice (hidden when live) -->
      <div id="m-offline">
        <span class="off-icon">ğŸ”Œ</span>
        Cannot reach<br>
        <code style="color:#ff9090" id="metrics-endpoint-display">localhost:8080/metrics</code>
      </div>

      <!-- CONTEXT WINDOW -->
      <div class="m-section" id="ms-ctx">
        <div class="m-sec-title">Context Window</div>
        <div class="m-bar-wrap">
          <div class="m-bar-top">
            <span class="m-lbl">This conversation</span>
            <span class="m-val g" id="m-ctx-val">0 / 2,048</span>
          </div>
          <div class="m-track"><div class="m-fill g" id="m-ctx-bar" style="width:0%"></div></div>
        </div>
        <div id="m-ctx-warn" style="display:none;margin-top:4px;font-size:9.5px;color:#ff5555;line-height:1.5;">
          âš  Approaching limit â€” old messages may be cut off
        </div>
      </div>

      <!-- ENGINE -->
      <div class="m-section" id="ms-engine">
        <div class="m-sec-title">Engine</div>
        <div class="m-row">
          <span class="m-lbl">Status</span>
          <span class="m-badge awake" id="m-engine-status">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Running reqs</span>
          <span class="m-val" id="m-running">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Waiting reqs</span>
          <span class="m-val" id="m-waiting">â€”</span>
        </div>
      </div>

      <!-- KV CACHE -->
      <div class="m-section" id="ms-kv">
        <div class="m-sec-title">KV Cache</div>
        <div class="m-bar-wrap">
          <div class="m-bar-top">
            <span class="m-lbl">GPU usage</span>
            <span class="m-val g" id="m-kv-pct">â€”</span>
          </div>
          <div class="m-track"><div class="m-fill g" id="m-kv-bar" style="width:0%"></div></div>
        </div>
        <div class="m-bar-wrap">
          <div class="m-bar-top">
            <span class="m-lbl">Prefix cache hit rate</span>
            <span class="m-val g" id="m-hit-pct">â€”</span>
          </div>
          <div class="m-track"><div class="m-fill g" id="m-hit-bar" style="width:0%"></div></div>
        </div>
      </div>

      <!-- TOKENS -->
      <div class="m-section" id="ms-tokens">
        <div class="m-sec-title">Tokens (cumulative)</div>
        <div class="m-row">
          <span class="m-lbl">Prompt tokens</span>
          <span class="m-val" id="m-ptok">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Generated tokens</span>
          <span class="m-val g" id="m-gtok">â€”</span>
        </div>
      </div>

      <!-- REQUESTS -->
      <div class="m-section" id="ms-reqs">
        <div class="m-sec-title">Requests</div>
        <div class="m-row">
          <span class="m-lbl">Success (stop)</span>
          <span class="m-val" id="m-rstop">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Truncated (length)</span>
          <span class="m-val" id="m-rlen">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Errors</span>
          <span class="m-val" id="m-rerr">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">HTTP 2xx</span>
          <span class="m-val" id="m-h2xx">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">HTTP 4xx</span>
          <span class="m-val" id="m-h4xx">â€”</span>
        </div>
      </div>

      <!-- LATENCY -->
      <div class="m-section" id="ms-lat">
        <div class="m-sec-title">Latency (avg)</div>
        <div class="m-row">
          <span class="m-lbl">Time to first token</span>
          <span class="m-val c" id="m-ttft">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">End-to-end</span>
          <span class="m-val" id="m-e2e">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Inter-token</span>
          <span class="m-val" id="m-itl">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Preemptions</span>
          <span class="m-val" id="m-preempt">â€”</span>
        </div>
      </div>

      <!-- PROCESS -->
      <div class="m-section" id="ms-proc">
        <div class="m-sec-title">Process</div>
        <div class="m-row">
          <span class="m-lbl">Resident memory</span>
          <span class="m-val" id="m-rss">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">CPU time</span>
          <span class="m-val" id="m-cpu">â€”</span>
        </div>
        <div class="m-row">
          <span class="m-lbl">Open FDs</span>
          <span class="m-val" id="m-fds">â€”</span>
        </div>
      </div>

      <div id="m-footer">â€” not yet fetched â€”</div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Get BASE_URL from environment variable if available, otherwise fallback to localhost
let BASE_URL = 'http://localhost:8080';
if (typeof process !== 'undefined' && process.env && process.env.API_BASE_URL) {
  BASE_URL = process.env.API_BASE_URL;
} else if (typeof VITE_API_BASE_URL !== 'undefined') {
  BASE_URL = VITE_API_BASE_URL; // common for vite
} else if (typeof importScripts === 'undefined' && typeof window !== 'undefined' && window.API_BASE_URL) {
  BASE_URL = window.API_BASE_URL; // custom injection
}

const API_URL = `${BASE_URL}/v1/chat/completions`;
const MODEL   = 'Qwen/Qwen2.5-Coder-0.5B-Instruct-AWQ';

// Update frontend display to reflect the dynamic URL
document.getElementById('endpoint-display').textContent = API_URL;
if (document.getElementById('metrics-endpoint-display')) {
  document.getElementById('metrics-endpoint-display').textContent = `${BASE_URL}/metrics`;
}

const chatContainer = document.getElementById('chat-container');
const userInput     = document.getElementById('user-input');
const sendBtn       = document.getElementById('send-btn');
let emptyState      = document.getElementById('empty-state');
const history       = [];

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function addMsg(role, content) {
  if (emptyState) { emptyState.remove(); emptyState = null; }
  const d = document.createElement('div');
  d.className = `message ${role}`;
  d.innerHTML = `<div class="avatar">${role==='user'?'YOU':'AI'}</div>
                 <div class="bubble">${esc(content)}</div>`;
  chatContainer.appendChild(d);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  return d;
}

function addThinking() {
  if (emptyState) { emptyState.remove(); emptyState = null; }
  const d = document.createElement('div');
  d.className = 'message assistant';
  d.innerHTML = `<div class="avatar">AI</div>
                 <div class="bubble"><div class="thinking"><span></span><span></span><span></span></div></div>`;
  chatContainer.appendChild(d);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  return d;
}

function addError(text) {
  const d = document.createElement('div');
  d.className = 'error-bubble';
  d.textContent = `âš  ${text}`;
  chatContainer.appendChild(d);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function send() {
  const content = userInput.value.trim();
  if (!content) return;
  userInput.value = '';
  userInput.style.height = 'auto';
  sendBtn.disabled = true;
  history.push({ role:'user', content });
  addMsg('user', content);
  updateContextMeter();
  const thinking = addThinking();
  try {
    const res  = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ model: MODEL, messages: history })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    const data  = await res.json();
    const reply = data.choices?.[0]?.message?.content ?? '(empty response)';
    history.push({ role:'assistant', content: reply });
    thinking.remove();
    addMsg('assistant', reply);
    fetchMetrics();
    updateContextMeter();
  } catch(e) {
    thinking.remove();
    addError(e.message || 'Failed to reach localhost:8080');
  } finally {
    sendBtn.disabled = false;
    userInput.focus();
  }
}

sendBtn.addEventListener('click', send);
userInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});
userInput.addEventListener('input', () => {
  userInput.style.height = 'auto';
  userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   METRICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const METRICS_URL   = `${BASE_URL}/metrics`;
const POLL_MS       = 5000;
const MAX_TOKENS    = 2048;
const CHARS_PER_TOK = 4;

function estimateTokens() {
  return Math.round(history.reduce((s, m) => s + m.content.length, 0) / CHARS_PER_TOK);
}

function updateContextMeter() {
  const used  = estimateTokens();
  const ratio = used / MAX_TOKENS;
  const pct   = Math.min(ratio * 100, 100);
  const cls   = pct > 85 ? 'r' : pct > 60 ? 'y' : 'g';

  const valEl  = document.getElementById('m-ctx-val');
  const barEl  = document.getElementById('m-ctx-bar');
  const warnEl = document.getElementById('m-ctx-warn');

  valEl.textContent = used.toLocaleString() + ' / ' + MAX_TOKENS.toLocaleString() + ' tokens';
  valEl.className   = 'm-val ' + cls;
  barEl.style.width = pct + '%';
  barEl.className   = 'm-fill ' + cls;

  if (pct > 90) {
    warnEl.style.display = 'block';
    warnEl.style.color   = '#ff3333';
    warnEl.textContent   = 'Critical â€” very close to limit!';
  } else if (pct > 75) {
    warnEl.style.display = 'block';
    warnEl.style.color   = '#ffaa44';
    warnEl.textContent   = 'Approaching limit â€” consider clearing chat';
  } else {
    warnEl.style.display = 'none';
  }
}

// Collapse toggle
document.getElementById('m-header').addEventListener('click', () => {
  const panel = document.getElementById('metrics-panel');
  panel.classList.toggle('collapsed');
  document.getElementById('m-toggle').textContent =
    panel.classList.contains('collapsed') ? 'â–²' : 'â–¼';
});

/* Parse Prometheus text â†’ Map of (metricName + raw label string) â†’ float */
function parsePrometheus(text) {
  const map = new Map();
  for (const raw of text.split('\n')) {
    const line = raw.trim();
    if (!line || line.startsWith('#')) continue;
    const m = line.match(/^([A-Za-z_:][^\s{]*)(\{[^}]*\})?\s+([\d.eE+\-]+)/);
    if (!m) continue;
    const name   = m[1];
    const labels = m[2] || '';
    const val    = parseFloat(m[3]);
    map.set(name + labels, val);   // exact key with labels
    map.set(name,           val);  // plain name (last write wins)
  }
  return map;
}

/* Get value by plain name; or by name + substring that must appear in labels */
function gv(map, name, labelSnip) {
  if (!labelSnip) return map.has(name) ? map.get(name) : NaN;
  for (const [k, v] of map) {
    if (k.startsWith(name + '{') && k.includes(labelSnip)) return v;
  }
  return NaN;
}

/* Formatters */
const fmt  = (n, d=0) => isNaN(n) ? 'â€”' : n.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});
const fms  = secs => isNaN(secs) ? 'â€”' : (secs*1000).toFixed(1)+' ms';
const fsec = secs => isNaN(secs) ? 'â€”' : secs.toFixed(2)+' s';
const fbyt = b => {
  if (isNaN(b)) return 'â€”';
  if (b>=1e9) return (b/1e9).toFixed(2)+' GB';
  if (b>=1e6) return (b/1e6).toFixed(1)+' MB';
  return b+' B';
};
const fpct = r => isNaN(r) ? 'â€”' : (r*100).toFixed(1)+'%';

/* Set a .m-val element */
function sv(id, text, cls) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = text;
  el.className = 'm-val' + (cls ? ' '+cls : '');
}

/* Set a progress bar */
function sbar(fillId, ratio) {
  const el = document.getElementById(fillId);
  if (!el) return;
  const pct = Math.min(Math.max((isNaN(ratio)?0:ratio)*100, 0), 100);
  el.style.width = pct + '%';
  el.className   = 'm-fill ' + (pct > 80 ? 'r' : pct > 50 ? 'y' : 'g');
}

const SECTIONS = ['ms-ctx','ms-engine','ms-kv','ms-tokens','ms-reqs','ms-lat','ms-proc'];

function setOffline(offline) {
  document.getElementById('m-offline').style.display = offline ? 'block' : 'none';
  document.getElementById('m-footer').style.display  = offline ? 'none' : '';
  SECTIONS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = offline ? 'none' : '';
  });
  const dot = document.getElementById('m-dot');
  dot.className = 'live-dot ' + (offline ? 'dead' : '');
}

async function fetchMetrics() {
  try {
    const res = await fetch(METRICS_URL, { cache:'no-store' });
    if (!res.ok) throw new Error('non-200');
    const text = await res.text();
    const m    = parsePrometheus(text);

    setOffline(false);

    /* â”€â”€ Engine â”€â”€ */
    const awake = gv(m, 'vllm:engine_sleep_state', 'sleep_state="awake"');
    const badge = document.getElementById('m-engine-status');
    const isAwake = awake === 1;
    badge.textContent = isAwake ? 'AWAKE' : 'SLEEPING';
    badge.className   = 'm-badge ' + (isAwake ? 'awake' : 'sleep');

    const running = gv(m, 'vllm:num_requests_running');
    const waiting = gv(m, 'vllm:num_requests_waiting');
    sv('m-running', fmt(running), running > 0 ? 'c' : '');
    sv('m-waiting', fmt(waiting), waiting > 0 ? 'y' : '');

    /* â”€â”€ KV Cache â”€â”€ */
    const kvU = gv(m, 'vllm:kv_cache_usage_perc');
    sv('m-kv-pct', fpct(kvU), kvU>0.8?'r': kvU>0.5?'y':'g');
    sbar('m-kv-bar', kvU);

    const pfQ = gv(m, 'vllm:prefix_cache_queries_total');
    const pfH = gv(m, 'vllm:prefix_cache_hits_total');
    const hr  = pfQ > 0 ? pfH / pfQ : 0;
    sv('m-hit-pct', fpct(hr), hr > 0.6 ? 'g' : hr > 0 ? 'y' : '');
    sbar('m-hit-bar', hr);

    /* â”€â”€ Tokens â”€â”€ */
    sv('m-ptok', fmt(gv(m,'vllm:prompt_tokens_total')));
    sv('m-gtok', fmt(gv(m,'vllm:generation_tokens_total')), 'g');

    /* â”€â”€ Requests â”€â”€ */
    const rStop = gv(m,'vllm:request_success_total','finished_reason="stop"');
    const rLen  = gv(m,'vllm:request_success_total','finished_reason="length"');
    const rErr  = gv(m,'vllm:request_success_total','finished_reason="error"');
    const h2xx  = gv(m,'http_requests_total','status="2xx"');
    const h4xx  = gv(m,'http_requests_total','status="4xx"');
    sv('m-rstop', fmt(rStop), rStop > 0 ? 'g' : '');
    sv('m-rlen',  fmt(rLen),  rLen  > 0 ? 'y' : '');
    sv('m-rerr',  fmt(rErr),  rErr  > 0 ? 'r' : '');
    sv('m-h2xx',  fmt(h2xx),  h2xx  > 0 ? 'c' : '');
    sv('m-h4xx',  fmt(h4xx),  h4xx  > 0 ? 'y' : '');

    /* â”€â”€ Latency â”€â”€ */
    const ttftS = gv(m,'vllm:time_to_first_token_seconds_sum');
    const ttftC = gv(m,'vllm:time_to_first_token_seconds_count');
    const e2eS  = gv(m,'vllm:e2e_request_latency_seconds_sum');
    const e2eC  = gv(m,'vllm:e2e_request_latency_seconds_count');
    const itlS  = gv(m,'vllm:inter_token_latency_seconds_sum');
    const itlC  = gv(m,'vllm:inter_token_latency_seconds_count');
    const preem = gv(m,'vllm:num_preemptions_total');

    sv('m-ttft',   ttftC>0 ? fms(ttftS/ttftC)  : 'â€”', 'c');
    sv('m-e2e',    e2eC >0 ? fsec(e2eS/e2eC)   : 'â€”');
    sv('m-itl',    itlC >0 ? fms(itlS/itlC)    : 'â€”');
    sv('m-preempt',fmt(preem), preem>0?'y':'');

    /* â”€â”€ Process â”€â”€ */
    sv('m-rss', fbyt(gv(m,'process_resident_memory_bytes')));
    sv('m-cpu', fmt(gv(m,'process_cpu_seconds_total'),1)+' s');
    sv('m-fds', fmt(gv(m,'process_open_fds')));

    /* â”€â”€ Footer â”€â”€ */
    const t = new Date();
    document.getElementById('m-footer').textContent =
      'â†» ' + t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});

  } catch(e) {
    setOffline(true);
  }
}

fetchMetrics();
setInterval(fetchMetrics, POLL_MS);
</script>
</body>
</html>
